const request = require('request-promise');
const u = require('./u');
const download = require('./download');

const urls = [
    ["35291", "108"],
["35290", "107"],
["35289", "106"],
["35288", "105"],
["35287", "104"],
["35286", "103"],
["35285", "102"],
["35284", "101"],
["35283", "100"],
["35282", "99"],
["35281", "98"],
["35280", "97"],
["35279", "96"],
["35278", "95"],
["35277", "94"],
["35276", "93"],
["35275", "92"],
["35274", "91"],
["35273", "90"],
["35272", "89"],
["35271", "88"],
["35270", "87"],
["35269", "86"],
["35268", "85"],
["35267", "84"],
["35266", "83"],
["35265", "82"],
["35264", "81"],
["35263", "80"],
["35262", "79"],
["35261", "78"],
["35260", "77"],
["35259", "76"],
["35258", "75"],
["35257", "74"],
["35256", "73"],
["35255", "72"],
["35254", "71"],
["35253", "70"],
["35252", "69"],
["35251", "68"],
["35250", "67"],
["35249", "66"],
["35248", "65"],
["35247", "64"],
["35246", "63"],
["35245", "62"],
["35244", "61"],
["35243", "60"],
["35242", "59"],
["35241", "58"],
["35240", "57"],
["35239", "56"],
["35238", "55"],
["35237", "54"],
["35236", "53"],
["35235", "52"],
["35234", "51"],
["35233", "50"],
["35232", "49"],
["35231", "48"],
["35230", "47"],
["35229", "46"],
["35228", "45"],
["35227", "44"],
["35226", "43"],
["35225", "42"],
["35224", "41"],
["35223", "40"],
["35222", "39"],
["35221", "38"],
["35220", "37"],
["35219", "36"],
["35218", "35"],
["35217", "34"],
["35216", "33"],
["35215", "32"],
["35214", "31"],
["35213", "30"],
["35212", "29"],
["35211", "28"],
["35210", "27"],
["35209", "26"],
["35208", "25"],
["35207", "24"],
["35206", "23"],
["35205", "22"],
["35204", "21"],
["35203", "20"],
["35202", "19"],
["35201", "18"],
["35200", "17"],
["35199", "16"],
["35198", "15"],
["35197", "14"],
["35196", "13"],
["35195", "12"],
["35194", "11"],
["35193", "10"],
["35192", "9"],
["35191", "8"],
["35190", "7"],
["35189", "6"],
["35188", "5"],
["35187", "4"],
["35186", "3"],
["35185", "2"],
["35184", "1"],
["35183", "12"],
["35182", "11"],
["35181", "10"],
["35180", "9"],
["35179", "8"],
["35178", "7"],
["35177", "6"],
["35176", "5"],
["35175", "4"],
["35174", "3"],
["35173", "2"],
["35172", "1"],
["35171", "前傳"],
	
]



async function run(){
    console.log('===开始执行爬虫===')
    for(const item of urls){
        const [id, title] = item;
        const host = `http://mangabz.com/m${id}`;
        console.log('===发起请求===', host)
        const res = await request({
            url: host,
            timeout: 5000,
            headers: {
                "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.3 Mobile/15E148 Safari/604.1",
                // "Cookie": "__cfduid=d161af501d346187891291234a938f558f451611040011; ComicHistoryitem_zh=History=265,637466651236912874706,108995,1,0,0,0,1&ViewType=0; mangabzimgpage=108995|1:1; MANGABZ_MACHINEKEY=c5044967-7eb8-4986-a485-55bb123d8f275dc"
                // Referer: host
            }
        }).catch(e => {
            console.log('请求超时1', host)
            urls.push([id, title])
            return null
        });

        console.log('接收请求', host)
        if(res){
            const text = res.split('eval(')[1].split(')\n')[0];
            eval('global.func = ' + text);
            eval(global.func);
            let i = 1;
            let arr = [];
            for(let src of newImgs){
                arr.push({
                    url: src,
                    path: `../死亡笔记/${title}/`,
                    fileName: i
                })
                i++;
            }
            await download(arr, {title, parallel: 5})
            console.log(`${title}:完成`);
        }else{
            console.log('请求超时', host)
        }
    }

    console.log('========全部下载完成========')
}

async function other() {
    let i = 116;
    while(i <= 135){
        let j = 1;
        const url = `https://twocomic.com/view/comic_6698.html?ch=${i}-${j}`;
        const {page} = u(j, url);
        const arr = [];
        while(j <= page){
            const url = `https://twocomic.com/view/comic_6698.html?ch=${i}-${j}`;
            const {img} = u(j, url);
            arr.push({
                url: img,
                path: `../怪怪守护神/第${i}话/`,
                fileName: j.toString()
            })
            j++;
        }
        // console.log(arr, i, page)
        const res = await download(arr, {title: `第${i}话`, parallel: 4})
        console.log(res, '===');
        i++;
    }
}

run().then()